<div class="page-header">
  <h2>{{ auth.userRole === 'volunteer' ? 'My Assigned Pickups' : 'My Pickups' }}</h2>
  <p>{{ auth.userRole === 'volunteer' ? 'Track and manage your assigned waste pickups' : 'View and manage your pickup requests' }}</p>
</div>

<div *ngIf="successMsg" class="alert-wz success mb-3">{{ successMsg }}</div>
<div *ngIf="errorMsg" class="alert-wz error mb-3">{{ errorMsg }}</div>

<!-- Filter tabs -->
<div class="d-flex gap-2 mb-3 flex-wrap">
  <button *ngFor="let f of statusFilters; trackBy: trackByIndex" (click)="filter = f"
    class="btn btn-sm rounded-pill"
    [class.btn-success]="filter === f"
    [class.btn-outline-secondary]="filter !== f"
    style="font-size:0.8rem">
    {{ f }}
  </button>
</div>

<div *ngIf="loading" class="text-center py-5"><div class="spinner-border text-success"></div></div>

<div *ngIf="!loading && !filteredPickups.length" class="card-wz text-center py-5 text-muted">
  <i class="bi bi-inbox fs-1 d-block mb-2"></i>
  No {{ filter !== 'All' ? filter.toLowerCase() : '' }} pickups found.
  <div class="mt-3" *ngIf="auth.userRole === 'user'">
    <a routerLink="/schedule-pickup" class="btn-wz-primary">Schedule a Pickup</a>
  </div>
  <div class="mt-3" *ngIf="auth.userRole === 'volunteer'">
    <a routerLink="/opportunities" class="btn-wz-primary">Browse Opportunities</a>
  </div>
</div>

<!-- Pickup cards -->
<div class="row g-3" *ngIf="!loading && filteredPickups.length">
  <div class="col-md-6 col-lg-4" *ngFor="let p of filteredPickups; trackBy: trackById">
    <div class="card-wz h-100">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <span class="waste-tag waste-{{p.wasteType}}">{{ p.wasteType }}</span>
        <span class="badge-{{p.status.toLowerCase()}}">{{ p.status }}</span>
      </div>
      <h6 class="fw-bold mb-1">{{ p.title }}</h6>
      <p class="text-muted mb-2" style="font-size:0.8rem">{{ p.description || 'No description' }}</p>

      <div style="font-size:0.82rem;color:#64748b" class="mb-2">
        <div><i class="bi bi-geo-alt me-1"></i>{{ p.address }}</div>
        <div><i class="bi bi-calendar me-1"></i>{{ p.preferredDate | date:'mediumDate' }} at {{ p.preferredTime }}</div>
        <div><i class="bi bi-box me-1"></i>{{ p.estimatedQuantity }}</div>
        <div *ngIf="auth.userRole === 'user'"><i class="bi bi-person-badge me-1"></i>Volunteer: {{ getVolunteer(p) }}</div>
        <div *ngIf="auth.userRole === 'volunteer'"><i class="bi bi-person me-1"></i>User: {{ getUser(p) }}</div>
      </div>

      <div class="d-flex gap-2 flex-wrap mt-auto">
        <!-- Volunteer actions -->
        <ng-container *ngIf="auth.userRole === 'volunteer'">
          <button *ngIf="p.status === 'Accepted'" class="btn-wz-primary btn-sm" (click)="complete(p._id)">
            <i class="bi bi-check-circle me-1"></i>Mark Complete
          </button>
          <button *ngIf="p.status === 'Accepted'" class="btn-wz-outline btn-sm" (click)="openMsgModal(p)">
            <i class="bi bi-chat me-1"></i>Message User
          </button>
        </ng-container>

        <!-- User actions -->
        <ng-container *ngIf="auth.userRole === 'user'">
          <button *ngIf="p.status === 'Accepted'" class="btn-wz-outline btn-sm" (click)="openMsgModal(p)">
            <i class="bi bi-chat me-1"></i>Message Volunteer
          </button>
          <button *ngIf="p.status === 'Open'" class="btn btn-sm btn-outline-danger" (click)="cancel(p._id)">
            <i class="bi bi-x-circle me-1"></i>Cancel
          </button>
        </ng-container>
      </div>

      <div class="mt-2" style="font-size:0.75rem;color:#94a3b8">
        Created {{ p.createdAt | date:'mediumDate' }}
        <span *ngIf="p.completedAt"> Â· Completed {{ p.completedAt | date:'mediumDate' }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Message Modal -->
<div *ngIf="msgModal" class="modal-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center">
  <div class="card-wz" style="width:440px;max-width:95vw">
    <h5 class="fw-bold mb-3">Send Message to {{ msgModal.receiverName }}</h5>
    <div class="form-group form-wz">
      <label>Message</label>
      <textarea [(ngModel)]="msgContent" rows="3" placeholder="Type your message..."></textarea>
    </div>
    <div class="d-flex gap-2 justify-content-end">
      <button class="btn-wz-outline" (click)="msgModal = null">Cancel</button>
      <button class="btn-wz-primary" (click)="sendMessage()" [disabled]="msgSending || !msgContent.trim()">
        <span *ngIf="msgSending" class="spinner-border spinner-border-sm me-1"></span>
        Send
      </button>
    </div>
  </div>
</div>
